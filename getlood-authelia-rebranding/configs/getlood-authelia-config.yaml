---
apiVersion: v1
kind: ConfigMap
metadata:
  name: getlood-authelia-config
  namespace: os-framework
data:
  configuration.yaml: |
    # Getlood Authelia Configuration
    # This configuration replaces the default Olares Authelia configuration
    # with Getlood branding

    jwt_secret: __JWT_SECRET__
    default_redirection_url: /

    server:
      host: 0.0.0.0
      port: 9091
      buffers:
        read: 10240

    log:
      level: debug

    # TOTP Configuration - Shows "getlood.com" in authenticator apps
    totp:
      issuer: getlood.com

    # Authentication Backend - LDAP Configuration
    authentication_backend:
      password_reset:
        disable: false
      refresh_interval: 5m
      lldap:
        implementation: custom
        url: ldap://lldap-service.os-platform:3890
        timeout: 5s
        start_tls: false
        base_dn: dc=getlood,dc=com
        additional_users_dn: ou=users
        users_filter: (&({username_attribute}={input})(objectClass=person))
        additional_groups_dn: ou=groups
        groups_filter: "(member={dn})"
        group_name_attribute: cn
        mail_attribute: mail
        display_name_attribute: displayName
        username_attribute: uid
        server: lldap-service.os-platform
        port: 17170
        user: cn=admin,dc=getlood,dc=com
        password: adminpassword

    # Access Control Rules - Updated for *.getlood.com domains
    access_control:
      config_type: terminus
      default_policy: deny
      rules:
        # Rules applied to everyone
        - domain: '*.getlood.com'
          policy: one_factor
        - domain: 'files.*.getlood.com'
          policy: two_factor

    # Session Configuration - Uses "getlood_session" cookie
    session:
      secret: __SESSION_SECRET__
      name: getlood_session
      same_site: 'none'
      cookies:
        - domain: 'getlood.com'
          authelia_url: https://authelia-svc.getlood.com/

    # Rate Limiting
    regulation:
      max_retries: 3
      find_time: 120
      ban_time: 300

    # Storage Configuration - PostgreSQL
    storage:
      encryption_key: __ENCRYPTION_KEY__
      postgres:
        host: citus-headless.os-platform
        port: 5432
        database: os_framework_authelia
        schema: public
        username: authelia_os_framework
        password: __PG_PASSWORD__
        timeout: 5s

    # Notifier Configuration
    notifier:
      disable_startup_check: false
      filesystem:
        filename: /app/notification.txt

    # OpenID Connect Configuration
    identity_providers:
      oidc:
        hmac_secret: __HMAC_SECRET__
        issuer_certificate_chain: |
__ISSUER_CERT_CHAIN__
        issuer_private_key: |
__ISSUER_PRIVATE_KEY__
        access_token_lifespan: 1h
        authorize_code_lifespan: 1m
        id_token_lifespan: 1h
        refresh_token_lifespan: 90m
        enable_client_debug_messages: false
        enforce_pkce: public_clients_only
        cors:
          endpoints:
            - authorization
            - token
            - revocation
            - introspection
        clients:
          # Getlood Desktop Client
          - id: getlood-desktop
            description: Getlood Desktop Application
            secret: '$pbkdf2-sha512$310000$c8p78n7pUMln0jzvd4aK4Q$JNRBzwAo0ek5qKn50cFzzvE9RXV88h1wJn5KGiHrD0YKtZaR/nCb2CJPOsKaPK0hjf.9yHxzQGZziziccp6Yng'
            sector_identifier: ''
            public: false
            authorization_policy: two_factor
            consent_mode: implicit
            pre_configured_consent_duration: 1w
            audience: []
            scopes:
              - openid
              - groups
              - email
              - profile
            redirect_uris:
              - https://desktop.getlood.com/auth/callback
              - https://app.getlood.com/auth/callback
            grant_types:
              - refresh_token
              - authorization_code
            response_types:
              - code
            response_modes:
              - form_post
              - query
              - fragment
            userinfo_signing_algorithm: none

          # Getlood Mobile Client
          - id: getlood-mobile
            description: Getlood Mobile Application
            secret: '$pbkdf2-sha512$310000$c8p78n7pUMln0jzvd4aK4Q$JNRBzwAo0ek5qKn50cFzzvE9RXV88h1wJn5KGiHrD0YKtZaR/nCb2CJPOsKaPK0hjf.9yHxzQGZziziccp6Yng'
            public: true
            authorization_policy: two_factor
            consent_mode: implicit
            pre_configured_consent_duration: 1w
            scopes:
              - openid
              - groups
              - email
              - profile
            redirect_uris:
              - getlood://auth/callback
              - https://mobile.getlood.com/auth/callback
            grant_types:
              - refresh_token
              - authorization_code
            response_types:
              - code
            response_modes:
              - query
            userinfo_signing_algorithm: none
