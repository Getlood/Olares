---
# Getlood Authelia Configuration Template
# This is a template that will be populated with environment variables at runtime

theme: getlood

server:
  host: 0.0.0.0
  port: 9091
  path: ""
  buffers:
    read: 4096
    write: 4096
  timeouts:
    read: 6s
    write: 6s
    idle: 30s
  asset_path: /app/public/assets/getlood

log:
  level: info
  format: text
  file_path: ""
  keep_stdout: true

# TOTP Configuration - Getlood Branding
totp:
  issuer: getlood.com
  period: 30
  skew: 1

# NTP Configuration
ntp:
  address: "time.cloudflare.com:123"
  version: 4
  max_desync: 3s
  disable_startup_check: false
  disable_failure: false

# Authentication Backend
authentication_backend:
  password_reset:
    disable: false
  refresh_interval: 5m
  ldap:
    implementation: custom
    url: ${AUTHELIA_LDAP_URL:-ldap://lldap:3890}
    timeout: 5s
    start_tls: false
    tls:
      skip_verify: false
      minimum_version: TLS1.2
    base_dn: ${AUTHELIA_LDAP_BASE_DN:-dc=getlood,dc=com}
    additional_users_dn: ou=users
    users_filter: "(&({username_attribute}={input})(objectClass=person))"
    additional_groups_dn: ou=groups
    groups_filter: "(member={dn})"
    group_name_attribute: cn
    username_attribute: uid
    mail_attribute: mail
    display_name_attribute: displayName
    user: ${AUTHELIA_LDAP_USER:-cn=admin,dc=getlood,dc=com}
    password: ${AUTHELIA_LDAP_PASSWORD}

# Access Control
access_control:
  default_policy: deny
  networks:
    - name: internal
      networks:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
  rules:
    # Public resources
    - domain:
        - "*.getlood.com"
      policy: bypass
      resources:
        - "^/api/health$"
        - "^/api/state$"

    # One-factor authentication for most resources
    - domain:
        - "*.getlood.com"
      policy: one_factor

    # Two-factor for sensitive resources
    - domain:
        - "admin.getlood.com"
        - "vault.getlood.com"
      policy: two_factor

# Session Configuration - Getlood Branding
session:
  name: getlood_session
  domain: ${AUTHELIA_SESSION_DOMAIN:-getlood.com}
  same_site: lax
  expiration: 1h
  inactivity: 5m
  remember_me_duration: 1M

  redis:
    host: ${AUTHELIA_REDIS_HOST:-redis}
    port: ${AUTHELIA_REDIS_PORT:-6379}
    database_index: 0
    maximum_active_connections: 8
    minimum_idle_connections: 0

# Regulation
regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

# Storage
storage:
  postgres:
    host: ${AUTHELIA_POSTGRES_HOST:-postgres}
    port: ${AUTHELIA_POSTGRES_PORT:-5432}
    database: ${AUTHELIA_POSTGRES_DATABASE:-authelia}
    schema: public
    username: ${AUTHELIA_POSTGRES_USERNAME:-authelia}
    timeout: 5s
    ssl:
      mode: disable

# Notifier
notifier:
  disable_startup_check: false
  smtp:
    host: ${AUTHELIA_SMTP_HOST:-smtp.gmail.com}
    port: ${AUTHELIA_SMTP_PORT:-587}
    timeout: 5s
    username: ${AUTHELIA_SMTP_USERNAME}
    sender: "Getlood <noreply@getlood.com>"
    identifier: getlood.com
    subject: "[Getlood] {title}"
    startup_check_address: ${AUTHELIA_SMTP_CHECK_ADDRESS:-test@getlood.com}
    disable_require_tls: false
    disable_html_emails: false
    tls:
      skip_verify: false
      minimum_version: TLS1.2

# Identity Providers - OIDC
identity_providers:
  oidc:
    hmac_secret: ${AUTHELIA_OIDC_HMAC_SECRET}
    issuer_private_key: |
      ${AUTHELIA_OIDC_ISSUER_PRIVATE_KEY}

    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m

    enable_client_debug_messages: false
    enforce_pkce: public_clients_only

    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins:
        - https://*.getlood.com
      allowed_origins_from_client_redirect_uris: true

    clients:
      - id: getlood-desktop
        description: Getlood Desktop Application
        secret: ${AUTHELIA_OIDC_CLIENT_SECRET_DESKTOP}
        public: false
        authorization_policy: two_factor
        consent_mode: implicit
        pre_configured_consent_duration: 1w
        scopes:
          - openid
          - groups
          - email
          - profile
        redirect_uris:
          - https://desktop.getlood.com/auth/callback
          - https://app.getlood.com/auth/callback
        grant_types:
          - refresh_token
          - authorization_code
        response_types:
          - code
        response_modes:
          - form_post
          - query
          - fragment
        userinfo_signing_algorithm: none

      - id: getlood-mobile
        description: Getlood Mobile Application
        secret: ${AUTHELIA_OIDC_CLIENT_SECRET_MOBILE}
        public: true
        authorization_policy: two_factor
        consent_mode: implicit
        pre_configured_consent_duration: 1w
        scopes:
          - openid
          - groups
          - email
          - profile
        redirect_uris:
          - getlood://auth/callback
          - https://mobile.getlood.com/auth/callback
        grant_types:
          - refresh_token
          - authorization_code
        response_types:
          - code
        response_modes:
          - query
        userinfo_signing_algorithm: none
